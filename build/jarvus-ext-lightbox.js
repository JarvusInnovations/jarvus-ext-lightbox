Ext.define("Jarvus.ux.LightBox",{extend:"Ext.util.Observable",singleton:true,requires:["Ext.Template"],config:{overlayOpacity:0.85,overlayDuration:200,animate:true,resizeSpeed:8,minWidth:300,minHeight:50,borderSize:10,labelImage:"Image",labelOf:"of",lightBoxTpl:['<div id="ux-lightbox">','<div id="ux-lightbox-outerImageContainer">','<div id="ux-lightbox-imageContainer">','<img id="ux-lightbox-image">','<div id="ux-lightbox-hoverNav">','<a href="#" id="ux-lightbox-navPrev"></a>','<a href="#" id="ux-lightbox-navNext"></a>',"</div>",'<div id="ux-lightbox-loading">','<a id="ux-lightbox-loadingLink"></a>',"</div>","</div>","</div>",'<div id="ux-lightbox-outerDataContainer">','<div id="ux-lightbox-dataContainer">','<div id="ux-lightbox-data">','<div id="ux-lightbox-details">','<span id="ux-lightbox-caption"></span>','<span id="ux-lightbox-imageNumber"></span>',"</div>",'<div id="ux-lightbox-bottomNav">','<a href="#" id="ux-lightbox-navClose"></a>',"</div>","</div>","</div>","</div>","</div>"].join("")},constructor:function(a){this.initConfig(a);this.addEvents("open","close");this.callParent(arguments);this.resizeDuration=this.getAnimate()?((11-this.getResizeSpeed())*150):0;this.images=[];this.selectors=[];Ext.onReady(this.onDocReady,this)},onDocReady:function(){this.initMarkup();this.initEvents()},initMarkup:function(){this.els={};this.els.shim=Ext.DomHelper.append(document.body,{tag:"iframe",id:"ux-lightbox-shim"},true);this.els.overlay=Ext.DomHelper.append(document.body,{id:"ux-lightbox-overlay"},true);var b=Ext.create("Ext.Template",this.getLightBoxTpl());this.els.lightbox=b.append(document.body,{},true);var c=["outerImageContainer","imageContainer","image","hoverNav","navPrev","navNext","loading","loadingLink","outerDataContainer","dataContainer","data","details","caption","imageNumber","bottomNav","navClose"];Ext.each(c,function(d){this.els[d]=Ext.get("ux-lightbox-"+d)},this);Ext.each([this.els.overlay,this.els.lightbox,this.els.shim],function(d){d.setVisibilityMode(Ext.Element.DISPLAY);d.hide()});var a=(this.getAnimate()?250:1)+"px";this.els.outerImageContainer.setStyle({width:a,height:a})},initEvents:function(){var a=function(b){b.preventDefault();this.close()};this.els.overlay.on("click",a,this);this.els.loadingLink.on("click",a,this);this.els.navClose.on("click",a,this);this.els.lightbox.on("click",function(b){if(b.getTarget().id=="ux-lightbox"){this.close()}},this);this.els.navPrev.on("click",function(b){b.preventDefault();this.setImage(this.activeImage-1)},this);this.els.navNext.on("click",function(b){b.preventDefault();this.setImage(this.activeImage+1)},this)},register:function(a,b){if(this.selectors.indexOf(a)===-1){this.selectors.push(a);Ext.fly(document).on("click",function(c){var d=c.getTarget(a);if(d){c.preventDefault();this.open(d,a,b)}},this)}},open:function(c,a,b){b=b||false;this.setViewSize();this.els.overlay.setOpacity(0.1).setVisible(true).animate({duration:this.getOverlayDuration(),to:{opacity:this.getOverlayOpacity()},listeners:{afteranimate:function(){this.images=[];var d=0;if(!b){this.images.push([c.href,c.title])}else{var e=Ext.query(a);Ext.each(e,function(i){if(i.href){this.images.push([i.href,i.title])}},this);while(this.images[d][0]!=c.href){d++}}var g=Ext.fly(document).getScroll();var h=g.top+(Ext.Element.getViewportHeight()/10);var f=g.left;this.els.lightbox.setStyle({top:h+"px",left:f+"px"}).show();this.setImage(d);this.fireEvent("open",this.images[d])},scope:this}})},setViewSize:function(){var a=Ext.Element.getViewSize();this.els.overlay.setStyle({width:a.width+"px",height:a.height+"px"});this.els.shim.setStyle({width:a.width+"px",height:a.height+"px"}).show()},setImage:function(b){this.activeImage=b;this.disableKeyNav();if(this.getAnimate()){this.els.loading.show()}this.els.image.hide();this.els.hoverNav.hide();this.els.navPrev.hide();this.els.navNext.hide();this.els.dataContainer.setOpacity(0.0001);this.els.imageNumber.hide();var a=new Image();a.onload=Ext.bind(function(){this.els.image.dom.src=this.images[this.activeImage][0];this.resizeImage(a.width,a.height)},this);a.src=this.images[this.activeImage][0]},resizeImage:function(g,b){g=Math.max(g,this.getMinWidth());b=Math.max(b,this.getMinHeight());var j=this.els.outerImageContainer.getWidth();var e=this.els.outerImageContainer.getHeight();var d=(g+this.borderSize*2);var c=(b+this.borderSize*2);var f=j-d;var a=e-c;var i=function(){this.els.hoverNav.setWidth(this.els.imageContainer.getWidth()+"px");this.els.navPrev.setHeight(b+"px");this.els.navNext.setHeight(b+"px");this.els.outerDataContainer.setWidth(d+"px");this.showImage()};if(a!=0||f!=0){this.els.outerImageContainer.shift({height:c,width:d,duration:this.resizeDuration,scope:this,callback:i,delay:50})}else{i.call(this)}},showImage:function(){this.els.loading.hide();this.els.image.show({duration:this.resizeDuration,listeners:{scope:this,afteranimate:function(){this.updateDetails()}}});this.preloadImages()},updateDetails:function(){var a=this.els.data.getWidth(true)-this.els.navClose.getWidth()-10;this.els.details.setWidth((a>0?a:0)+"px");this.els.caption.update(this.images[this.activeImage][1]);this.els.caption.show();if(this.images.length>1){this.els.imageNumber.update(this.labelImage+" "+(this.activeImage+1)+" "+this.labelOf+"  "+this.images.length);this.els.imageNumber.show()}this.els.dataContainer.show({duration:this.resizeDuration/2,listeners:{scope:this,afteranimate:function(){var b=Ext.Element.getViewSize();this.els.overlay.setHeight(b.height+"px");this.updateNav()}}})},updateNav:function(){this.enableKeyNav();this.els.hoverNav.show();if(this.activeImage>0){this.els.navPrev.show()}if(this.activeImage<(this.images.length-1)){this.els.navNext.show()}},enableKeyNav:function(){Ext.fly(document).on("keydown",this.keyNavAction,this)},disableKeyNav:function(){Ext.fly(document).un("keydown",this.keyNavAction,this)},keyNavAction:function(a){var b=a.getKey();if(b==88||b==67||b==27){this.close()}else{if(b==80||b==37){if(this.activeImage!=0){this.setImage(activeImage-1)}}else{if(b==78||b==39){if(this.activeImage!=(this.images.length-1)){this.setImage(this.activeImage+1)}}}}},preloadImages:function(){var a,b;if(this.images.length>this.activeImage+1){a=new Image();a.src=this.images[this.activeImage+1][0]}if(this.activeImage>0){b=new Image();b.src=this.images[this.activeImage-1][0]}},close:function(){this.disableKeyNav();this.els.lightbox.hide();this.els.overlay.hide({duration:this.overlayDuration});this.els.shim.hide();this.fireEvent("close",this.activeImage)}});